name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.11', '3.13']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install TeX Live (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-base \
          texlive-latex-base \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-extra-utils \
          texlive-science \
          texlive-fonts-recommended \
          latexmk
        # Verify installation
        which pdflatex
        which pythontex
        which latexmk
    
    - name: Install TeX Live (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install --cask basictex
        # Wait for installation to complete
        sleep 10
        # Add to PATH immediately
        export PATH="/Library/TeX/texbin:$PATH"
        # Update tlmgr and install all needed packages
        sudo tlmgr update --self
        sudo tlmgr install latexmk pythontex collection-latexrecommended \
          minted fvextra catchfile xstring framed fancyvrb upquote lineno \
          float caption geometry pgf currfile etoolbox xcolor hyperref bookmark
        # Verify installation worked
        which pdflatex
        which pythontex
        which latexmk
    
    - name: Add TeX Live to PATH (macOS)
      if: runner.os == 'macOS'
      run: |
        # Add TeX Live to PATH for all subsequent steps
        echo "/Library/TeX/texbin" >> $GITHUB_PATH
        # Verify PATH is set
        echo "PATH is now: $PATH"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
    
    - name: Install Python package (editable)
      run: |
        pip install -e .
    
    - name: Run Python tests
      run: |
        pytest tests/python -v
    
    - name: Verify TeX installation
      run: |
        # Debug PATH on macOS
        if [ "$RUNNER_OS" == "macOS" ]; then
          echo "PATH before: $PATH"
          export PATH="/Library/TeX/texbin:$PATH"
          echo "PATH after: $PATH"
        fi
        pdflatex --version
        pythontex --version
        latexmk --version
    
    - name: Run installer script (sets up TeX files in TEXMFHOME)
      run: |
        if [ "$RUNNER_OS" == "macOS" ]; then
          export PATH="/Library/TeX/texbin:$PATH"
        fi
        bash scripts/install.sh
      shell: bash
    
    - name: Compile example document
      run: |
        # Ensure PATH for macOS
        if [ "$RUNNER_OS" == "macOS" ]; then
          export PATH="/Library/TeX/texbin:$PATH"
        fi
        cd examples
        latexmk -pdf -shell-escape example-gallery.tex
    
    - name: Check PDF output
      run: |
        if [ ! -f examples/example-gallery.pdf ]; then
          echo "Error: PDF not generated"
          exit 1
        fi
        echo "PDF size: $(stat -f%z examples/example-gallery.pdf 2>/dev/null || stat -c%s examples/example-gallery.pdf) bytes"
    
    - name: Verify cache generation
      run: |
        if [ ! -d examples/lp-cache ]; then
          echo "Error: Cache directory not created"
          exit 1
        fi
        cache_files=$(ls examples/lp-cache/*.tex 2>/dev/null | wc -l)
        echo "Cache files generated: $cache_files"
        if [ "$cache_files" -eq 0 ]; then
          echo "Error: No cache files generated"
          exit 1
        fi
    
    - name: Upload PDF artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: example-pdf-${{ matrix.os }}-py${{ matrix.python-version }}
        path: examples/example-gallery.pdf
        if-no-files-found: warn
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          examples/*.log
          examples/build.log
        if-no-files-found: ignore
